# 项目架构概述

本项目为基于 Electron + React + TypeScript 的跨平台桌面应用，使用 electron-vite 统一开发与构建主进程（main）、预加载（preload）与渲染端（renderer），并通过 electron-builder 进行打包发布。

## 技术栈
- Electron（主/渲染多进程架构）
- React、React DOM（前端视图层）
- TypeScript（类型系统）
- Vite、electron-vite（开发与打包）
- electron-builder（跨平台安装包）
- ESLint、Prettier（代码质量与格式）
- pnpm（包管理）

## 目录结构
- `src/main/`：主进程入口与窗口管理（`src/main/index.ts`）
- `src/preload/`：预加载脚本与安全桥接（`src/preload/index.ts`、`src/preload/index.d.ts`）
- `src/renderer/`：渲染端页面与前端代码（`src/renderer/index.html`、`src/renderer/src/*`）
  - 入口：`src/renderer/src/main.tsx`
  - 应用：`src/renderer/src/App.tsx`
  - 组件示例：`src/renderer/src/components/Versions.tsx`
- `build/`：打包资源（应用图标、macOS entitlements）
- `resources/`：运行时资源（如应用图标）
- `docs/`：项目文档（本文件 `docs/架构.md`）
- 根配置与工程文件：`package.json`、`electron.vite.config.ts`、`electron-builder.yml`、`tsconfig*.json`、`eslint.config.mjs`、`.npmrc`、`.editorconfig`

## 核心模块
### 主进程（`src/main/index.ts`）
- 创建 `BrowserWindow`，启用 `sandbox: true` 与 `contextIsolation: true`
- 通过 `preload: ../preload/index.js` 注入预加载脚本
- 开发环境：加载 `ELECTRON_RENDERER_URL`；生产环境：`loadFile('../renderer/index.html')`
- 注册 IPC 示例：`ipcMain.on('ping', () => console.log('pong'))`
- 集成 `@electron-toolkit/utils` 进行环境与快捷键支持

### 预加载（`src/preload/index.ts`）
- 在 `contextIsolation` 下使用 `contextBridge` 安全暴露 API 到渲染端
- 暴露对象：`window.electron`（官方 API 包装）、`window.api`（自定义示例）
- 当隔离未开启时降级直接挂载到 `window`

### 渲染端（`src/renderer/index.html`、`src/renderer/src/*`）
- `index.html` 提供入口与严格 CSP 配置
- `main.tsx` 启动 React 应用，`App.tsx` 展示版本信息并通过 `window.electron.ipcRenderer.send('ping')` 与主进程通信
- 组件与资源位于 `src/renderer/src/components/` 与 `src/renderer/src/assets/`

## 数据流与安全
- 进程通信：渲染端 → 预加载 → 主进程，示例为 `ping` 事件（`ipcRenderer.send('ping')` 与 `ipcMain.on('ping')`）
- 安全边界：
  - 启用 `contextIsolation: true` 与 `sandbox: true`
  - 通过 `preload` 的 `contextBridge` 以白名单方式暴露接口
  - `index.html` 采用严格 CSP：`default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:`

## 构建与打包
- 开发与构建脚本（`package.json`）：
  - `pnpm dev`：同时启动 main/preload/renderer 的开发模式
  - `pnpm build`：类型检查后构建三端产物
  - `pnpm start`：预览渲染端构建结果
  - `build:win`、`build:mac`、`build:linux`：按平台打包安装包（调用 `electron-builder`）
- 打包配置（`electron-builder.yml`）：
  - Windows 使用 `nsis`，生成 `setup` 安装程序
  - macOS 指定 `entitlements` 与权限描述，支持签名/公证配置占位
  - Linux 目标包含 `AppImage/snap/deb`
  - `asarUnpack: resources/**` 保持资源可解包

## 配置与环境
- `electron.vite.config.ts`：定义 main/preload/renderer 三块构建配置，渲染端别名 `@renderer -> src/renderer/src`
- TypeScript：
  - `tsconfig.node.json`（主进程与预加载）
  - `tsconfig.web.json`（渲染端，`jsx: react-jsx`，路径别名 `@renderer/*`）
  - `tsconfig.json`（工程引用聚合）
- 包与镜像：`.npmrc` 与 `electron-builder.yml.electronDownload` 指定镜像加速；`pnpm.onlyBuiltDependencies` 优化安装

## 代码质量与规范
- `eslint.config.mjs`：Flat config，整合 TypeScript/React/Hooks/Refresh 与 Prettier
- `.prettierrc.yaml`、`.prettierignore`、`.editorconfig`：统一格式与忽略项
- `pnpm lint`、`pnpm format`：日常质量检查与格式化

## 开发与运行
1. 安装依赖：`pnpm install`
2. 开发调试：`pnpm dev`
3. 类型检查：`pnpm typecheck`
4. 构建产物：`pnpm build`
5. 打包发布：`pnpm run build:win|build:mac|build:linux`

## 关键文件清单
- 入口与进程：`src/main/index.ts`、`src/preload/index.ts`、`src/renderer/index.html`
- 渲染端应用：`src/renderer/src/main.tsx`、`src/renderer/src/App.tsx`、`src/renderer/src/components/Versions.tsx`
- 构建与配置：`electron.vite.config.ts`、`electron-builder.yml`、`package.json`
- TypeScript：`tsconfig.json`、`tsconfig.node.json`、`tsconfig.web.json`
- 质量与格式：`eslint.config.mjs`、`.prettierrc.yaml`、`.prettierignore`、`.editorconfig`
- 资源与权限：`resources/icon.png`、`build/icon.*`、`build/entitlements.mac.plist`

## 现状与改进建议
- 测试：当前未集成单元/端到端测试，可考虑引入 `vitest` 或 `jest` 与 `playwright`
- 自动更新：`electron-builder.yml` 使用占位的 `generic` 发布源，部署时需替换为实际更新服务
- 安全：继续以最小暴露原则管理 `preload` API，避免直接从渲染端访问 Node 能力
